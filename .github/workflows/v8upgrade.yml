name: V8 Upgrade

on:
    workflow_dispatch:
    schedule:
    - cron: '0 0 * * *' # Run every day

jobs:
    upgrade:
        name: Upgrade V8
        runs-on: ubuntu-latest
        outputs:
            latest_v8_hash: ${{ steps.check_v8.latest_v8_hash }}
            has_upgrade: ${{ steps.check_v8.has_upgrade }}

        steps:
        - name: Install Utilities
          run: |
              sudo apt-get update
              sudo apt-get install -qy --no-install-recommends jq

        - name: Checkout
          uses: actions/checkout@v4
          with:
              submodules: true
              fetch-depth: 1

        - id: check_v8
          name: Check Latest Stable Chromium V8
          run: |
              set -o pipefail
              wget -q -O- "https://chromiumdash.appspot.com/fetch_releases?channel=Stable&platform=Linux&num=1&offset=0" | jq -r ".[0].hashes.v8" >deps/latest_v8_hash
              echo "latest_v8_hash=$(<deps/latest_v8_hash)" >>"$GITHUB_OUTPUT"
              echo "has_upgrade=$(git status --porcelain | grep -q . && echo y || echo n)" >>"$GITHUB_OUTPUT"

        - name: Create PR
          if: ${{ steps.check_v8.has_upgrade }} == 'y'
          uses: peter-evans/create-pull-request@v5
          with:
              commit-message: Records new V8 release (${{ steps.check_v8.latest_v8_hash }})
              title: Records new V8 release (${{ steps.check_v8.latest_v8_hash }})
              body: |
                  This is an automated bump of the V8 release hash based on the Chromium dashboard.
                  Code changes will happen on the next run of the build workflow.
              add-paths: deps/latest_v8_hash
              branch: workflow/v8upgrade
              delete-branch: true
